FROM ubuntu:20.04

# Configure noninteractive installation
ENV DEBIAN_FRONTEND=noninteractive

# Install basic dependencies and wget
RUN apt-get update && apt-get install -y \
    make \
    cmake \
    build-essential \
    wget \
    gnupg \
    software-properties-common \
    gdb

# Install LLVM and Clang 18
RUN wget -qO- https://apt.llvm.org/llvm.sh | bash -s -- 18

# Create FTP user and required directories
RUN useradd -m -s /bin/bash ftptest
RUN mkdir -p /home/ftptest && \
    chmod 777 /home/ftptest && \
    chown ftptest:ftptest /home/ftptest

RUN useradd -m -s /bin/bash ftp
RUN mkdir -p /home/ftp/uploads && \
    chmod 777 /home/ftp/uploads && \
    chown ftp:ftp /home/ftp/uploads

# Install OpenSSL
WORKDIR /build
RUN wget http://www.openssl.org/source/openssl-1.0.1g.tar.gz
RUN tar -xvzf openssl-1.0.1g.tar.gz
WORKDIR /build/openssl-1.0.1g
RUN ./config --prefix=/usr/local/openssl --openssldir=/usr/local/openssl
RUN make
RUN make install_sw
ENV CPPFLAGS="-I/usr/local/openssl/include"
ENV LDFLAGS="-L/usr/local/openssl/lib -ldl"

# Install Metasploit Framework
WORKDIR /build
RUN wget https://raw.githubusercontent.com/rapid7/metasploit-omnibus/master/config/templates/metasploit-framework-wrappers/msfupdate.erb && \
    chmod 755 msfupdate.erb && \
    ./msfupdate.erb

# Install ProFTPD
COPY mount/proftpd-1.3.0.tar.gz /build
RUN tar xzf proftpd-1.3.0.tar.gz
WORKDIR /build/proftpd-1.3.0
RUN CC=clang-18 CFLAGS="-fno-stack-protector -O0 -g" ./configure --prefix=/usr/local/proftpd-1.3.0 --with-modules=mod_tls
RUN make
RUN make install
WORKDIR /build/proftpd-1.3.0/contrib
RUN cp ftpasswd /usr/local/bin/
RUN chmod 755 /usr/local/bin/ftpasswd

# Clean up build files
RUN rm -rf /build/*

# Create virtual FTP user
RUN mkdir -p /etc/proftpd && \
    echo "ftptest:ftptest" | ftpasswd --passwd --file=/etc/proftpd/ftpd.passwd \
    --name=ftptest \
    --uid=2001 \
    --gid=2001 \
    --home=/home/ftptest \
    --shell=/bin/bash --stdin && \
    chmod 400 /etc/proftpd/ftpd.passwd && \
    chown ftptest:ftptest /etc/proftpd/ftpd.passwd

COPY mount/proftpd.conf mount/server.crt mount/server.key /usr/local/proftpd-1.3.0/etc
COPY mount/pam.conf /home/ftptest/etc/pam.conf

RUN mkdir -p $HOME/.msf4/modules/exploits/windows/ftp/
COPY mount/exploits/proftp_sreplace_getkey.rb /root/.msf4/modules/exploits/windows/ftp/

WORKDIR ~

CMD ["/usr/local/proftpd-1.3.0/sbin/proftpd", "--nodaemon"]
